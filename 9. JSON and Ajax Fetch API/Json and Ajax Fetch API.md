# JSON Ajax Fetch API

[B·∫£n g·ªëc: Ph·∫ßn 6 (Ph·∫ßn cu·ªëi): JSON v√† Ajax trong Javascript](https://xdevclass.com/phan-6-json-va-ajax-trong-javascript/)

## JSON

JSON (**J**ava**S**cript **O**bject **N**otation) l√† m·ªôt chu·ªói text ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng Javascript Object d√πng ƒë·ªÉ l∆∞u tr·ªØ v√† trao ƒë·ªïi d·ªØ li·ªáu.

JSON th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ l∆∞u tr·ªØ string, number, boolean, array, object, null.

ƒê·ªãnh d·∫°ng JSON c√≥ th·ªÉ d·ªÖ d√†ng s·ª≠ d·ª•ng ·ªü c√°c ng√¥n ng·ªØ l·∫≠p tr√¨nh kh√°c nhau. ·ªû Javascript b·∫°n c√≥ th·ªÉ thao t√°c v·ªõi JSON th√¥ng qua `JSON.parse()` v√† `JSON.stringify()`

### Chuy·ªÉn Object th√†nh JSON

```js
const myObj = {
  name: 'John',
  age: 30,
  cars: ['Ford', 'BMW', 'Fiat']
}
const myJSON = JSON.stringify(myObj)
console.log(myJSON) // '{"name":"John","age":30,"cars":["Ford","BMW","Fiat"]}'
```

### Chuy·ªÉn JSON th√†nh Object

```js
// Ch√∫ √Ω l√† d√πng d·∫•u ' ho·∫∑c ` ngo√†i c√πng th√¨ JS m·ªõi cho ph√©p
const myJSON = `{"name":"John","age":30,"cars":["Ford","BMW","Fiat"]}`
const myObj = JSON.parse(myJSON)
```

### C√∫ ph√°p JSON

- Data l√† c·∫∑p name/value
- Data ƒë∆∞·ª£c ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y
- Ngo·∫∑c nh·ªçn m√¥ t·∫£ object
- Ngo·∫∑c vu√¥ng m√¥ t·∫£ array
- JSON d·∫•u nh√°y k√©p
- Tr∆∞·ªùng name ph·∫£i b·ªçc trong nh√°y k√©p

## Value trong JSON ph·∫£i l√† m·ªôt trong nh·ªØng ki·ªÉu d·ªØ li·ªáu d∆∞·ªõi ƒë√¢y

- string
- number
- object
- array
- boolean
- null

## Array v√† JSON

```js
// Array
const arr = ['Ford', 'BMW', 'Fiat']
// JSON
const json = '[ "Ford", "BMW", "Fiat" ]'
```

Ngo√†i c√°c gi√° tr·ªã ƒë∆∞·ª£c n√™u b√™n tr√™n th√¨ c√°c gi√° tr·ªã nh∆∞ **Function, undefined, NaN, Infinity**,‚Ä¶ s·∫Ω kh√¥ng ƒë∆∞·ª£c chuy·ªÉn sang JSON nh√©

```js
var obj = {
  name: 'John',
  age: function () {
    return 30
  },
  city: 'New York'
}
var myJSON = JSON.stringify(obj)
console.log(myJSON) // '{"name":"John","city":"New York"}'
```

## AJAX

AJAX = **A**synchronous **J**avaScript **A**nd **X**ML.

AJAX kh√¥ng ph·∫£i l√† m·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh

AJAX ch·ªâ l√† s·ª± k·∫øt h·ª£p c·ªßa

- XMLHttpRequest object c√≥ s·∫µn tr√™n tr√¨nh duy·ªát (d√πng ƒë·ªÉ g·ª≠i v√† nh·∫≠n data t·ª´ web server)
- Javascript v√† HTML DOM (ƒë·ªÉ hi·ªÉn th·ªã ho·∫∑c s·ª≠ d·ª•ng data)

C√°i t√™n AJAX d·ªÖ g√¢y hi·ªÉu l·∫ßm l√† ·ª©ng d·ª•ng d√πng AJAX s·∫Ω s·ª≠ d·ª•ng XML (m·ªôt ki·ªÉu data nh∆∞ JSON nh∆∞ng ph·ª©c t·∫°p h∆°n) ƒë·ªÉ g·ª≠i v√† nh·∫≠n d·ªØ li·ªáu. Nh∆∞ng tr√™n th·ª±c t·∫ø th√¨ ch√∫ng ta ch·ªß y·∫øu d√πng text ho·∫∑c JSON ƒë·ªÉ trao ƒë·ªïi d·ªØ li·ªáu.

AJAX gi√∫p ch√∫ng ta ƒë·ªçc d·ªØ li·ªáu t·ª´ server tr·∫£ v·ªÅ, g·ª≠i d·ªØ li·ªáu l√™n server ·ªü ch·∫ø ƒë·ªô ng·∫ßm, c·∫≠p nh·∫≠t trang web m√† kh√¥ng c·∫ßn reload l·∫°i trang. V√¨ s·ª± ti·ªán l·ª£i c·ªßa AJAX m√† ch√∫ng ta ƒë√£ c√≥ React, Angular v√† Vue üòÜ

### C√°ch AJAX ho·∫°t ƒë·ªông

![Ajax](pic_ajax.gif)

1. M·ªôt s·ª± ki·ªán x·∫£y ra ·ªü trang web (trang ƒë∆∞·ª£c load, m·ªôt button ƒë∆∞·ª£c click)
2. M·ªôt XMLHttpRequest object ƒë∆∞·ª£c t·∫°o b·ªüi Javascript
3. XMLHttpRequest object g·ª≠i m·ªôt request ƒë·∫øn web server
4. Server x·ª≠ l√Ω request ƒë√≥
5. Server g·ª≠i response v·ªÅ cho trang web
6. Response ƒë∆∞·ª£c ƒë·ªçc b·ªüi Javascript
7. Th·ª±c hi·ªán m·ªôt s·ªë h√†nh ƒë·ªông tr√™n trang web b·∫±ng Javascript (v√≠ d·ª• nh∆∞ c·∫≠p nh·∫≠t l·∫°i trang)

### XMLHttpRequest

XMLHttpRequest (XHR) l√† m·ªôt constructor function (m√¨nh ƒë√£ gi·ªõi thi·ªáu v·ªÅ constructor function trong ![b√†i n√†y](https://xdevclass.com/phan-3-thao-tac-voi-number-string-array-object-va-class-trong-javascript/)) d√πng ƒë·ªÉ giao ti·∫øp v·ªõi server. XHR c≈©ng l√† m·ªôt Web APIs n√™n n√≥ ch·ªâ c√≥ tr√™n m√¥i tr∆∞·ªùng tr√¨nh duy·ªát, kh√¥ng xu·∫•t hi·ªán ·ªü Node.js nha :mrgreen:

### T·∫°o m·ªôt XMLHttpRequest object

```js
var xhttp = new XMLHttpRequest()
```

### M·ªôt s·ªë ph∆∞∆°ng th·ª©c c·ªßa XMLHttpRequest object

| Ph∆∞∆°ng th·ª©c                         | M√¥ t·∫£                                                                                                                                                                                                                        |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| new XMLHttpRequest()                | T·∫°o m·ªõi XMLHttpRequest object                                                                                                                                                                                                |
| abort()                             | H·ªßy request hi·ªán t·∫°i                                                                                                                                                                                                         |
| getAllResponseHeaders()             | Returns t·∫•t c·∫£ th√¥ng tin header                                                                                                                                                                                              |
| getResponseHeader()                 | Returns th√¥ng tin header ch·ªâ ƒë·ªãnh                                                                                                                                                                                            |
| open(method, url, async, user, psw) | Quy ƒë·ªãnh request; method: Lo·∫°i request (GET, POST, PUT, DELETE); url: ƒë∆∞·ªùng d·∫´n ƒë·∫øn server; async: true (b·∫•t ƒë·ªìng b·ªô) ho·∫∑c false (ƒë·ªìng b·ªô); user: t√πy ch·ªçn username; psw: t√πy ch·ªçn password                                  |
| send(body)                          | G·ª≠i body data ƒë·∫øn server. body c√≥ th·ªÉ l√†; Document, c·∫ßn serialized tr∆∞·ªõc khi g·ª≠i; Blob, BufferSource, FormData, URLSearchParams, or USVString object.null; N·∫øu kh√¥ng c√≥ gi√° tr·ªã n√†o cho body th√¨ m·∫∑c ƒë·ªãnh null ƒë∆∞·ª£c s·ª≠ d·ª•ng. |
| setRequestHeader()                  | Th√™m c√°c gi√° tr·ªã v√†o trong header request                                                                                                                                                                                    |

### M·ªôt s·ªë thu·ªôc t√≠nh c·ªßa XMLHttpRequest object

| Thu·ªôc t√≠nh         | M√¥ t·∫£                                                                                                                                                                                                                 |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| onreadystatechange | X√°c ƒë·ªãnh m·ªôt function ƒë∆∞·ª£c g·ªçi khi thu·ªôc t√≠nh readyState thay ƒë·ªïi                                                                                                                                                     |
| readyState         | M√¥ t·∫£ tr·∫°ng th√°i c·ªßa XMLHttpRequest.0: request ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o. 1: k·∫øt n·ªëi v·ªõi server ƒë∆∞·ª£c thi·∫øt l·∫≠p. 2: request ƒë∆∞·ª£c server ti·∫øp nh·∫≠n. 3: ƒëang x·ª≠ l√Ω request. 4: request k·∫øt th√∫c v√† response ƒë√£ s·∫µn s√†ng ƒë·ªÉ d√πng |
| responseText       | Return v·ªÅ response nh∆∞ m·ªôt string                                                                                                                                                                                     |
| responseXML        | Return v·ªÅ response nh∆∞ m·ªôt XML                                                                                                                                                                                        |
| status             | Return v·ªÅ status c·ªßa request. 200: ‚ÄúOK‚Äù. 403: ‚ÄúForbidden‚Äù. 404: ‚ÄúNot Found‚Äù. Xem danh s√°ch ƒë·∫ßy ƒë·ªß t·∫°i [Http Messages Reference](https://www.w3schools.com/tags/ref_httpmessages.asp)                                  |
| statusText         | Return v·ªÅ status d·∫°ng text (V√≠ d·ª• ‚ÄúOK‚Äù ho·∫∑c ‚ÄúNot Found‚Äù)                                                                                                                                                              |

### V√≠ d·ª• v·ªÅ c√°ch d√πng XHR ƒë·ªÉ GET

```js
function loadDoc() {
  var xhttp = new XMLHttpRequest()
  // function n√†y s·∫Ω ch·∫°y m·ªói khi readyState thay ƒë·ªïi
  xhttp.onreadystatechange = function () {
    // Khi request th√†nh c√¥ng
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById('demo').innerHTML = this.responseText
    }
  }
  xhttp.open('GET', 'https://httpbin.org/get', true)
  xhttp.send()
}
loadDoc()
```

### V√≠ d·ª• v·ªÅ c√°ch d√πng XHR ƒë·ªÉ POST

```js
function send() {
  var xhttp = new XMLHttpRequest()
  // function n√†y s·∫Ω ch·∫°y m·ªói khi readyState thay ƒë·ªïi
  xhttp.onreadystatechange = function () {
    // Khi request th√†nh c√¥ng
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById('demo').innerHTML = this.responseText
    }
  }
  xhttp.open('POST', 'https://httpbin.org/post', true)
  const body = { name: 'Du Thanh Duoc', age: 24, point: 100 }
  xhttp.send(JSON.stringify(body))
}
send()
```

D√πng `XMLHttpRequest` ƒë·ªÉ x·ª≠ l√Ω AJAX ƒë∆∞·ª£c coi l√† c√°ch ‚Äúc·ªï x∆∞a‚Äù nh·∫•t v√† r∆∞·ªùm r√† nh·∫•t. Ng√†y nay ch√∫ng ta c√≥ r·∫•t nhi·ªÅu t√πy ch·ªçn m·∫°nh m·∫Ω ƒë·ªÉ x·ª≠ l√Ω AJAX. M√¨nh c√≥ th·ªÉ li·ªát k√™ ra

- N·∫øu d√πng [Jquery](https://jquery.com/) th√¨ Jquery cung c·∫•p cho ch√∫ng ta nhi·ªÅu h√†m g·ªçi AJAX r·∫•t ti·ªán l·ª£i nh∆∞ `load`, `ajax`, `get`, `getJSON`
- Nh·ªØng tr√¨nh duy·ªát ng√†y n√†y cung c·∫•p m·ªôt API kh√°c `XMLHttpRequest` ƒë√≥ l√† [Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API), v·ªõi nhi·ªÅu t√≠nh nƒÉng n√¢ng cao v√† c√∫ ph√°p d·ªÖ s·ª≠ d·ª•ng h∆°n `XMLHttpRequest`
- Ph·ªï bi·∫øn nh·∫•t ph·∫£i k·ªÉ ƒë·∫øn [Axios](https://github.com/axios/axios), m·ªôt th∆∞ vi·ªán chuy√™n d·ª•ng cho vi·ªác x·ª≠ l√Ω AJAX c≈©ng nh∆∞ g·ªçi API. Cung c·∫•p h√†ng t√° t√≠nh nƒÉng hay, d√πng ƒë∆∞·ª£c cho c·∫£ m√¥i tr∆∞·ªùng tr√¨nh duy·ªát v√† Node (n·∫øu tr√¨nh duy·ªát n√≥ s·∫Ω d·ª±a tr√™n XHR, n·∫øu l√† Node th√¨ l√† [HTTP interface](https://nodejs.org/api/http.html))

## Fetch API

Fetch l√† m·ªôt API ƒë∆°n gi·∫£n cung c·∫•p cho ch√∫ng ta kh·∫£ nƒÉng g·ª≠i v√† nh·∫≠n request th√¥ng qua tr√¨nh duy·ªát. N·∫øu nh∆∞ `XMLHttpRequest` d√πng callback th√¨ Fetch API d√πng Promise, v√¨ th·∫ø s·∫Ω ti·ªán l·ª£i h∆°i khi thao t√°c v√† x·ª≠ l√Ω.

M·ªôt setup request ƒë∆°n gi·∫£n v·ªõi fetch

```js
fetch('http://example.com/movies.json')
  .then((response) => response.json())
  .then((data) => console.log(data))
```

L∆∞u √Ω l√† Promise return t·ª´ `fetch()` **s·∫Ω kh√¥ng reject d·ª±a tr√™n HTTP error status** ngay c·∫£ khi HTTP 404 ho·∫∑c 500. Thay v√¨ ƒë√≥, n√≥ s·∫Ω resolve b√¨nh th∆∞·ªùng (v·ªõi `ok` status l√† false), v√† n√≥ ch·ªâ s·∫Ω reject khi m√† m·∫°ng l·ªói ho·∫∑c b·∫•t c·ª© ƒëi·ªÅu g√¨ ngƒÉn c·∫£ request ho√†n th√†nh.

```js
fetch('examples/example.json')
  .then(function (response) {
    if (!response.ok) {
      throw Error(response.statusText)
    }
    // Do stuff with the response
  })
  .catch(function (error) {
    console.log('Looks like there was a problem: \n', error)
  })
```

### ƒê·ªçc m·ªôt response

```js
fetch('examples/example.json')
  .then(function (response) {
    if (!response.ok) {
      throw Error(response.statusText)
    }
    // Read the response as json.
    return response.json()
  })
  .then(function (responseAsJson) {
    // Do stuff with the JSON
    console.log(responseAsJson)
  })
  .catch(function (error) {
    console.log('Looks like there was a problem: \n', error)
  })
```

M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng truy·ªÅn tham s·ªë th·ª© 2 th√¨ fetch s·∫Ω d√πng ph∆∞∆°ng th·ª©c GET, c√≤n mu·ªën ch·ªâ r√µ ph∆∞∆°ng th·ª©c nh∆∞ POST, PUT‚Ä¶ th√¨ ph·∫£i truy·ªÅn tham s·ªë th·ª© 2 v√†o.

V√≠ d·ª• POST

```js
// Example POST method implementation:
async function postData(url = '', data = {}) {
  // Default options are marked with *
  const response = await fetch(url, {
    method: 'POST', // *GET, POST, PUT, DELETE, etc.
    mode: 'cors', // no-cors, *cors, same-origin
    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
    credentials: 'same-origin', // include, *same-origin, omit
    headers: {
      'Content-Type': 'application/json'
      // 'Content-Type': 'application/x-www-form-urlencoded',
    },
    redirect: 'follow', // manual, *follow, error
    referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
    body: JSON.stringify(data) // body data type must match "Content-Type" header
  })
  return response.json() // parses JSON response into native JavaScript objects
}
postData('https://example.com/answer', { answer: 42 }).then((data) => {
  console.log(data) // JSON data parsed by `data.json()` call
})
```
